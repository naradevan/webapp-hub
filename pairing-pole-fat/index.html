<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KML/KMZ POLE-FAT Processor (Manual)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
  // Load GA setelah page fully loaded
  window.addEventListener('load', function() {
    var script = document.createElement('script');
    script.async = true;
    script.src = 'https://www.googletagmanager.com/gtag/js?id=G-T12DERDD3M';
    document.head.appendChild(script);
    
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-T12DERDD3M');
  });
</script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #2d2d2d;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        h1 {
            color: #ffffff;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .subtitle {
            color: #a0a0a0;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .upload-area {
            border: 2px dashed #555;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #242424;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area.dragover {
            border-color: #4a90e2;
            background: #2a2a2a;
        }
        
        .upload-area p {
            color: #a0a0a0;
            margin: 10px 0;
        }
        
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        label {
            color: #b0b0b0;
            font-weight: 500;
            font-size: 14px;
        }
        
        input[type="number"] {
            width: 80px;
            padding: 8px;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 14px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        select {
            padding: 8px 12px;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 14px;
            background: #1a1a1a;
            color: #e0e0e0;
            cursor: pointer;
            min-width: 150px;
        }
        
        select:focus {
            outline: none;
            border-color: #4a90e2;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-primary {
            background: #4a90e2;
            color: white;
        }
        
        .btn-primary:hover {
            background: #3a7bc8;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-secondary {
            background: #555;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #666;
        }
        
        button:disabled {
            background: #3a3a3a;
            color: #666;
            cursor: not-allowed;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .stat-box {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            background: #242424;
            border-radius: 6px;
            border-left: 4px solid #4a90e2;
        }
        
        .stat-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #ffffff;
        }
        
        .warnings {
            background: #3a3020;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
            display: none;
        }
        
        .warnings.show {
            display: block;
        }
        
        .warnings ul {
            margin-left: 20px;
            color: #ffd54f;
        }
        
        .folder-selection {
            background: #1a2332;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        
        .folder-selection.show {
            display: block;
        }
        
        .folder-selection h3 {
            color: #64b5f6;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .folder-selection .instructions {
            color: #90caf9;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .folder-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .folder-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #242424;
            border-radius: 6px;
            border: 1px solid #333;
        }
        
        .folder-name {
            flex: 1;
            color: #ffffff;
            font-weight: 500;
        }
        
        .folder-count {
            color: #888;
            font-size: 13px;
        }
        
        .folder-type-select {
            min-width: 180px;
        }
        
        .confirm-selection {
            margin-top: 20px;
            text-align: right;
        }
        
        .debug-info {
            background: #1a2332;
            border-left: 4px solid #2196f3;
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
            font-size: 13px;
            font-family: 'Courier New', monospace;
            display: none;
        }
        
        .debug-info h4 {
            color: #64b5f6;
            margin-bottom: 8px;
        }
        
        .debug-info .folder-item-debug {
            padding: 4px 0;
            color: #90caf9;
        }
        
        .debug-info .folder-item-debug.fat {
            color: #ffb74d;
        }
        
        .debug-info .folder-item-debug.pole {
            color: #81c784;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #444;
            border-radius: 6px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        thead {
            position: sticky;
            top: 0;
            background: #1a1a1a;
            color: white;
            z-index: 10;
        }
        
        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #4a90e2;
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #333;
        }
        
        tr:hover {
            background: #242424;
        }
        
        .step-indicator {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: #242424;
            border-radius: 6px;
        }
        
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 4px;
            background: #1a1a1a;
            color: #666;
        }
        
        .step.active {
            background: #4a90e2;
            color: white;
        }
        
        .step.completed {
            background: #27ae60;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóÇÔ∏è KML/KMZ POLE-FAT Processor (Manual Selection)</h1>
        <p class="subtitle">Upload file KML/KMZ, pilih folder FAT & POLE secara manual, lalu proses pairing</p>
        
        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" id="step1">1. Upload File</div>
            <div class="step" id="step2">2. Pilih Folder</div>
            <div class="step" id="step3">3. Proses Data</div>
            <div class="step" id="step4">4. Export</div>
        </div>
        
        <!-- Upload Area -->
        <div class="upload-area" id="uploadArea">
            <p style="font-size: 48px; margin-bottom: 10px;">üìÅ</p>
            <p style="font-size: 16px; font-weight: 600;">Klik atau drag & drop file KML/KMZ</p>
            <p style="font-size: 13px;">File akan dianalisis dan folder akan ditampilkan untuk dipilih</p>
            <input type="file" id="fileInput" accept=".kml,.kmz" style="display: none;">
        </div>
        
        <!-- Folder Selection Area -->
        <div class="folder-selection" id="folderSelection">
            <h3>üìÇ Pilih Tipe untuk Setiap Folder</h3>
            <div class="instructions">
                Pilih tipe data untuk setiap folder yang ditemukan. Folder yang dipilih sebagai <strong>FAT</strong> akan dipairing dengan folder yang dipilih sebagai <strong>POLE</strong>. Folder yang dipilih <strong>Abaikan</strong> tidak akan diproses.
            </div>
            <div class="folder-list" id="folderList"></div>
            <div class="confirm-selection">
                <button class="btn-success" id="confirmBtn" onclick="confirmFolderSelection()">‚úì Konfirmasi Pilihan & Lanjutkan</button>
            </div>
        </div>
        
        <!-- Debug Info -->
        <div class="debug-info" id="debugInfo"></div>
        
        <!-- Controls -->
        <div class="controls" id="controls" style="display: none;">
            <div class="control-group">
                <label for="radius">Radius Pairing (m):</label>
                <input type="number" id="radius" value="100" min="1">
            </div>
            <button class="btn-primary" id="processBtn" onclick="processData()">‚öôÔ∏è Proses Pairing</button>
            <button class="btn-success" id="exportBtn" onclick="exportCSV()" disabled>üíæ Export CSV</button>
        </div>
        
        <!-- Stats -->
        <div class="stats" id="stats" style="display: none;">
            <div class="stat-box">
                <div class="stat-label">Total POLE</div>
                <div class="stat-value" id="totalPoles">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Total FAT</div>
                <div class="stat-value" id="totalFats">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">POLE Terpairing</div>
                <div class="stat-value" id="pairedPoles">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">POLE Tidak Terpairing</div>
                <div class="stat-value" id="removedPoles">0</div>
            </div>
        </div>
        
        <!-- Warnings -->
        <div class="warnings" id="warnings">
            <strong>‚ö†Ô∏è Peringatan:</strong>
            <ul id="warningList"></ul>
        </div>
        
        <!-- Table -->
        <div class="table-container" id="tableContainer" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Nama POLE</th>
                        <th>Nama FAT</th>
                        <th>Latitude</th>
                        <th>Longitude</th>
                        <th>Jarak (m)</th>
                    </tr>
                </thead>
                <tbody id="resultTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        let kmlData = null;
        let processedData = null;
        let folderData = [];
        let rawPlacemarks = [];
        
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const exportBtn = document.getElementById('exportBtn');
        
        // Upload handlers
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });
        
        async function handleFile(file) {
            const fileName = file.name.toLowerCase();
            
            // Update step indicator
            updateStep(1);
            
            try {
                if (fileName.endsWith('.kmz')) {
                    const zip = await JSZip.loadAsync(file);
                    const kmlFile = Object.keys(zip.files).find(name => name.endsWith('.kml'));
                    if (!kmlFile) {
                        alert('File KML tidak ditemukan dalam KMZ');
                        return;
                    }
                    const kmlText = await zip.files[kmlFile].async('text');
                    parseKMLForFolders(kmlText);
                } else if (fileName.endsWith('.kml')) {
                    const text = await file.text();
                    parseKMLForFolders(text);
                } else {
                    alert('Format file tidak didukung. Gunakan .kml atau .kmz');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error membaca file: ' + error.message);
            }
        }
        
        function updateStep(stepNumber) {
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active', 'completed');
                if (i < stepNumber) {
                    step.classList.add('completed');
                } else if (i === stepNumber) {
                    step.classList.add('active');
                }
            }
        }
        
        function parseKMLForFolders(kmlText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(kmlText, 'text/xml');
            
            folderData = [];
            rawPlacemarks = [];
            
            // Fungsi untuk mendapatkan immediate parent folder dari placemark
            function getImmediateFolder(element) {
                let current = element;
                
                // Naik ke atas sampai ketemu Folder
                while (current && current.parentNode) {
                    current = current.parentNode;
                    if (current.tagName === 'Folder') {
                        const nameEl = current.querySelector(':scope > name');
                        if (nameEl) {
                            const name = nameEl.textContent.trim();
                            // Skip folder dengan nama "Point" atau nama yang terlalu generic
                            if (name && name.toUpperCase() !== 'POINT') {
                                return name;
                            }
                        }
                    }
                }
                return null;
            }
            
            // Fungsi untuk mengambil semua Placemark
            function extractPlacemarks(element) {
                const placemarks = element.getElementsByTagName('Placemark');
                
                for (let i = 0; i < placemarks.length; i++) {
                    const placemark = placemarks[i];
                    
                    const nameEl = placemark.getElementsByTagName('name')[0];
                    const name = nameEl ? nameEl.textContent.trim() : '';
                    
                    const pointEl = placemark.getElementsByTagName('Point')[0];
                    if (!pointEl) continue;
                    
                    const coordsEl = pointEl.getElementsByTagName('coordinates')[0];
                    if (!coordsEl) continue;
                    
                    const coords = coordsEl.textContent.trim().split(',');
                    const lon = parseFloat(coords[0]);
                    const lat = parseFloat(coords[1]);
                    
                    if (isNaN(lat) || isNaN(lon)) continue;
                    
                    // Cari immediate parent folder dari placemark ini
                    const immediateFolder = getImmediateFolder(placemark);
                    
                    if (!immediateFolder) continue;
                    
                    // Simpan raw placemark
                    rawPlacemarks.push({
                        name: name,
                        lat: lat,
                        lon: lon,
                        folder: immediateFolder
                    });
                    
                    // Track folder
                    let folder = folderData.find(f => f.name === immediateFolder);
                    if (!folder) {
                        folder = {
                            name: immediateFolder,
                            count: 0,
                            type: 'ignore' // default: ignore
                        };
                        folderData.push(folder);
                    }
                    folder.count++;
                }
            }
            
            // Mulai dari Document atau root
            const doc = xmlDoc.getElementsByTagName('Document')[0] || xmlDoc.documentElement;
            extractPlacemarks(doc);
            
            // Tampilkan folder selection UI
            displayFolderSelection();
            
            // Sembunyikan upload area
            document.getElementById('uploadArea').style.display = 'none';
            
            // Update step
            updateStep(2);
        }
        
        function displayFolderSelection() {
            const folderList = document.getElementById('folderList');
            
            if (folderData.length === 0) {
                folderList.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">Tidak ada folder ditemukan</div>';
                return;
            }
            
            folderList.innerHTML = folderData.map((folder, idx) => `
                <div class="folder-item">
                    <div class="folder-name">${folder.name}</div>
                    <div class="folder-count">(${folder.count} points)</div>
                    <select class="folder-type-select" id="folderType${idx}" onchange="updateFolderType(${idx}, this.value)">
                        <option value="ignore" selected>‚ùå Abaikan</option>
                        <option value="fat">üìç FAT (Fiber Access Terminal)</option>
                        <option value="pole">üóº POLE (Tiang)</option>
                    </select>
                </div>
            `).join('');
            
            document.getElementById('folderSelection').classList.add('show');
        }
        
        function updateFolderType(idx, type) {
            folderData[idx].type = type;
        }
        
        function confirmFolderSelection() {
            // Validasi: pastikan ada minimal 1 FAT dan 1 POLE
            const hasFAT = folderData.some(f => f.type === 'fat');
            const hasPOLE = folderData.some(f => f.type === 'pole');
            
            if (!hasFAT) {
                alert('‚ö†Ô∏è Pilih minimal 1 folder sebagai FAT');
                return;
            }
            
            if (!hasPOLE) {
                alert('‚ö†Ô∏è Pilih minimal 1 folder sebagai POLE');
                return;
            }
            
            // Process data berdasarkan pilihan user
            processSelectedFolders();
            
            // Hide folder selection, show controls
            document.getElementById('folderSelection').classList.remove('show');
            document.getElementById('controls').style.display = 'flex';
            
            // Update step
            updateStep(3);
        }
        
        function processSelectedFolders() {
            const poles = [];
            const fats = [];
            
            // Filter placemarks berdasarkan pilihan folder
            rawPlacemarks.forEach(pm => {
                const folder = folderData.find(f => f.name === pm.folder);
                if (!folder) return;
                
                if (folder.type === 'fat') {
                    fats.push({
                        name: pm.name,
                        lat: pm.lat,
                        lon: pm.lon,
                        used: false,
                        folder: pm.folder
                    });
                } else if (folder.type === 'pole') {
                    poles.push({
                        name: pm.name,
                        lat: pm.lat,
                        lon: pm.lon,
                        folder: pm.folder
                    });
                }
            });
            
            kmlData = { poles, fats };
            
            // Tampilkan debug info
            const debugInfo = document.getElementById('debugInfo');
            let debugHTML = '<h4>‚úì Folder yang Dipilih:</h4>';
            folderData.forEach(folder => {
                if (folder.type === 'ignore') return;
                const cssClass = folder.type === 'fat' ? 'fat' : 'pole';
                const icon = folder.type === 'fat' ? 'üìç' : 'üóº';
                const label = folder.type === 'fat' ? 'FAT' : 'POLE';
                debugHTML += `<div class="folder-item-debug ${cssClass}">${icon} [${label}] ${folder.name} (${folder.count} points)</div>`;
            });
            debugHTML += `<div style="margin-top: 10px; color: #64b5f6;">‚úì Ditemukan ${poles.length} POLE dan ${fats.length} FAT</div>`;
            debugInfo.innerHTML = debugHTML;
            debugInfo.style.display = 'block';
        }
        
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Radius bumi dalam meter
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function processData() {
            const radius = parseFloat(document.getElementById('radius').value);
            const { poles, fats } = kmlData;
            
            const results = [];
            const warnings = [];
            
            // Reset status penggunaan FAT
            fats.forEach(fat => fat.used = false);
            
            // Buat array semua kandidat pairing dengan jarak
            const candidates = [];
            for (let pole of poles) {
                for (let fat of fats) {
                    const dist = haversineDistance(pole.lat, pole.lon, fat.lat, fat.lon);
                    if (dist <= radius) {
                        candidates.push({
                            pole: pole,
                            fat: fat,
                            distance: dist
                        });
                    }
                }
            }
            
            // Urutkan berdasarkan jarak terdekat
            candidates.sort((a, b) => a.distance - b.distance);
            
            // Track POLE dan FAT yang sudah digunakan
            const usedPoles = new Set();
            const usedFats = new Set();
            
            // Proses pairing 1:1 berdasarkan jarak terdekat
            for (let candidate of candidates) {
                const poleId = candidate.pole.name;
                const fatId = candidate.fat.name;
                
                // Skip jika POLE atau FAT sudah digunakan
                if (usedPoles.has(poleId) || usedFats.has(fatId)) {
                    continue;
                }
                
                // Pairing berhasil - POLE sebagai POLE, FAT sebagai FAT
                results.push({
                    poleName: candidate.pole.name,
                    fatName: candidate.fat.name,
                    lat: candidate.pole.lat,
                    lon: candidate.pole.lon,
                    distance: candidate.distance.toFixed(2)
                });
                
                usedPoles.add(poleId);
                usedFats.add(fatId);
                candidate.fat.used = true;
            }
            
            // Hitung POLE yang tidak dapat dipairing
            const unpairedPoles = poles.length - usedPoles.size;
            if (unpairedPoles > 0) {
                warnings.push(`${unpairedPoles} POLE tidak dapat dipairing (tidak ada FAT dalam radius ${radius}m atau FAT sudah terpakai)`);
            }
            
            // Hitung FAT yang tidak terpakai
            const unusedFats = fats.length - usedFats.size;
            if (unusedFats > 0) {
                warnings.push(`${unusedFats} FAT tidak terpakai (tidak ada POLE dalam radius ${radius}m)`);
            }
            
            processedData = results;
            
            // Update stats
            document.getElementById('totalPoles').textContent = poles.length;
            document.getElementById('totalFats').textContent = fats.length;
            document.getElementById('pairedPoles').textContent = results.length;
            document.getElementById('removedPoles').textContent = poles.length - results.length;
            document.getElementById('stats').style.display = 'flex';
            
            // Update warnings
            if (warnings.length > 0) {
                const warningList = document.getElementById('warningList');
                warningList.innerHTML = warnings.map(w => `<li>${w}</li>`).join('');
                document.getElementById('warnings').classList.add('show');
            } else {
                document.getElementById('warnings').classList.remove('show');
            }
            
            // Update table
            const tbody = document.getElementById('resultTable');
            tbody.innerHTML = results.map((row, idx) => `
                <tr>
                    <td>${idx + 1}</td>
                    <td>${row.poleName}</td>
                    <td>${row.fatName}</td>
                    <td>${row.lat.toFixed(6)}</td>
                    <td>${row.lon.toFixed(6)}</td>
                    <td>${row.distance}</td>
                </tr>
            `).join('');
            
            document.getElementById('tableContainer').style.display = 'block';
            exportBtn.disabled = false;
            
            // Update step
            updateStep(4);
        }
        
        function exportCSV() {
            if (!processedData || processedData.length === 0) {
                alert('Tidak ada data untuk diekspor');
                return;
            }
            
            let csv = 'No,Nama POLE,Nama FAT,Latitude,Longitude,Jarak (m)\n';
            processedData.forEach((row, idx) => {
                // Format Latitude ke 9 karakter
                let latStr = row.lat.toFixed(7); // Mulai dengan 7 decimal places
                if (latStr.length > 9) {
                    latStr = latStr.substring(0, 9); // Potong jadi 9 karakter
                } else {
                    latStr = latStr.padEnd(9, '0'); // Pad dengan 0 jika kurang
                }
                
                // Format Longitude ke 10 karakter
                let lonStr = row.lon.toFixed(7); // Mulai dengan 7 decimal places
                if (lonStr.length > 10) {
                    lonStr = lonStr.substring(0, 10); // Potong jadi 10 karakter
                } else {
                    lonStr = lonStr.padEnd(10, '0'); // Pad dengan 0 jika kurang
                }
                
                csv += `${idx + 1},"${row.poleName}","${row.fatName}",${latStr},${lonStr},${row.distance}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'pole_fat_pairing_' + new Date().toISOString().slice(0,10) + '.csv';
            link.click();
        }
    </script>
</body>
</html>
