<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMZ Styler V25 (Ultimate Fix Pole Color)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --bg-body: #0d0d0d; --bg-surface: #171717; --bg-surface-hover: #222; --border: #333; --primary: #3b82f6; --primary-hover: #2563eb; --text-main: #ededed; --text-muted: #888; --success: #22c55e; --error: #ef4444; --radius: 8px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg-body); color: var(--text-main); line-height: 1.5; min-height: 100vh; display: flex; justify-content: center; padding-top: 5vh; }
        .container { width: 100%; max-width: 680px; padding: 0 1.5rem; }
        header { margin-bottom: 2rem; text-align: center; }
        h1 { font-size: 1.75rem; font-weight: 600; letter-spacing: -0.03em; margin-bottom: 0.5rem; background: linear-gradient(to bottom right, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { color: var(--text-muted); font-size: 0.95rem; }
        .card { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 2rem; margin-bottom: 1.5rem; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5); }
        .mode-selector { display: flex; background: #222; padding: 4px; border-radius: 8px; margin-bottom: 1.5rem; }
        .mode-option { flex: 1; text-align: center; padding: 10px; cursor: pointer; font-size: 0.9rem; font-weight: 600; color: var(--text-muted); border-radius: 6px; transition: all 0.2s; }
        .mode-option.active { color: #fff; background: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .file-drop-area { border: 2px dashed var(--border); border-radius: var(--radius); height: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; background: rgba(255,255,255,0.01); margin-bottom: 1.5rem; color: var(--text-muted); }
        .file-drop-area:hover { border-color: var(--primary); background: rgba(59, 130, 246, 0.05); color: var(--text-main); }
        .file-drop-area.active { border-color: var(--success); background: rgba(34, 197, 94, 0.05); }
        #fileLabel { font-size: 0.95rem; pointer-events: none; transition: color 0.2s; }
        input[type="file"] { display: none; }
        .btn-group { display: flex; gap: 10px; justify-content: center; }
        button { padding: 0.75rem 1.5rem; border-radius: 6px; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; }
        button.primary { background: var(--primary); color: white; box-shadow: 0 2px 10px rgba(59, 130, 246, 0.2); }
        button.primary:hover:not(:disabled) { background: var(--primary-hover); transform: translateY(-1px); }
        button.primary:disabled { background: var(--bg-surface-hover); color: var(--text-muted); cursor: not-allowed; box-shadow: none; }
        button.secondary { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        button.secondary:hover { border-color: var(--text-muted); background: var(--bg-surface-hover); }
        #status { margin-top: 1.5rem; font-size: 0.9rem; text-align: center; min-height: 24px; }
        .folder-list { background: #111; border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; max-height: 400px; overflow-y: auto; font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 0.85rem; }
        .tree-item { margin-left: 1.5rem; border-left: 1px solid #333; padding-left: 0.75rem; margin-bottom: 0.25rem; position: relative; }
        .tree-folder { color: #fbbf24; font-weight: 600; }
        .tree-subfolder { color: #4ade80; }
        .tree-info { color: #666; font-size: 0.8em; margin-left: 0.5rem; }
        .hidden { display: none; }
        .loading-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: text-bottom; }
        @keyframes spin { to { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>KMZ Styler EMR STANDARD V25</h1>
            <p class="subtitle">update by 30/12/2025</p>
        </header>

        <div class="card">
            <div class="mode-selector">
                <div class="mode-option active" onclick="setMode('cluster')" id="btn-cluster">CLUSTER MODE</div>
                <div class="mode-option" onclick="setMode('subfeeder')" id="btn-subfeeder">SUBFEEDER MODE</div>
            </div>

            <label class="file-drop-area" id="dropArea">
                <span id="fileLabel">Drag & drop KMZ/KML here or click to upload</span>
                <input type="file" id="kmzFile" accept=".kmz, .kml" />
            </label>

            <div class="btn-group">
                <button id="processBtn" class="primary" disabled>Process File</button>
                <button id="resetBtn" class="secondary">Reset</button>
            </div>
            
            <div id="status"></div>
        </div>

        <div id="preview" class="hidden">
            <div class="card" style="padding: 1rem;">
                <h3 style="font-size: 0.9rem; margin-bottom: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Structure Preview</h3>
                <div class="folder-list" id="folderList"></div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        let CURRENT_MODE = 'cluster'; 
        const TEXT_SIZE = 1.0; // Label scale

        // --- CLUSTER STRUCTURE ---
        const STRUCTURE_CLUSTER = [
            'BOUNDARY FAT', 'FAT', 'HP COVER', 'HP UNCOVER',
            'EXISTING POLE EMR 7-2.5', 'EXISTING POLE EMR 7-3', 'EXISTING POLE EMR 7-4', 'EXISTING POLE EMR 9-4',
            'EXISTING POLE PARTNER 7-4', 'EXISTING POLE PARTNER 9-4',
            'NEW POLE 7-2.5', 'NEW POLE 7-3', 'NEW POLE 7-4', 'NEW POLE 9-4',
            'DISTRIBUTION CABLE', 'SLACK HANGER', 'SLING WIRE'
        ];

        const RULES_CLUSTER = [
            { folder: '-', placemark: '288C', line: '-', polygon: '-', colorCode: '#AA0000', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/cross-hairs.png' },
            { folder: '-', placemark: '144C', line: '-', polygon: '-', colorCode: '#FFFF00', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/cross-hairs.png' },
            { folder: '-', placemark: '96C', line: '-', polygon: '-', colorCode: '#00FFFF', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/cross-hairs.png' },
            { folder: '-', placemark: '72C', line: '-', polygon: '-', colorCode: '#0000FF', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/cross-hairs.png' },
            { folder: '-', placemark: '48C', line: '-', polygon: '-', colorCode: '#AA00FF', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/cross-hairs.png' },
            
            // BOUNDARY FAT
            { folder: 'BOUNDARY FAT', placemark: '-', line: '-', polygon: '-', colorCode: '#009999', styleLink: '-' },
            
            { folder: 'FAT', placemark: '-', line: '-', polygon: '-', colorCode: '#FFFF00', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/triangle.png' },
            { folder: 'HP COVER', placemark: '-', line: '-', polygon: '-', colorCode: '#00FF00', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/homegardenbusiness.png' },
            { folder: 'HP UNCOVER', placemark: '-', line: '-', polygon: '-', colorCode: '#ff0000', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/homegardenbusiness.png' },
            
            // POLES
            { folder: 'NEW POLE 9-4', placemark: 'NEW POLE 9-4', line: '-', polygon: '-', colorCode: '#FF0000', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png' },
            { folder: 'NEW POLE 7-4', placemark: 'NEW POLE 7-4', line: '-', polygon: '-', colorCode: '#00FF00', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png' },
            { folder: 'NEW POLE 7-3', placemark: 'NEW POLE 7-3', line: '-', polygon: '-', colorCode: '#00FFFF', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png' },
            { folder: 'NEW POLE 7-2.5', placemark: 'NEW POLE 7-2.5', line: '-', polygon: '-', colorCode: '#AA00FF', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png' },
            { folder: 'EXISTING POLE EMR 7-2.5', placemark: 'EXISTING POLE EMR 7-2.5', line: '-', polygon: '-', colorCode: '#550000', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png' },
            { folder: 'EXISTING POLE EMR 7-3', placemark: 'EXISTING POLE EMR 7-3', line: '-', polygon: '-', colorCode: '#550000', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png' },
            { folder: 'EXISTING POLE EMR 7-4', placemark: 'EXISTING POLE EMR 7-4', line: '-', polygon: '-', colorCode: '#550000', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png' },
            { folder: 'EXISTING POLE EMR 9-4', placemark: 'EXISTING POLE EMR 9-4', line: '-', polygon: '-', colorCode: '#550000', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png' },
            { folder: 'EXISTING POLE PARTNER 7-4', placemark: 'EXISTING POLE PARTNER 7-4', line: '-', polygon: '-', colorCode: '#550000', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png' },
            { folder: 'EXISTING POLE PARTNER 9-4', placemark: 'EXISTING POLE PARTNER 9-4', line: '-', polygon: '-', colorCode: '#550000', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png' },
            
            // CABLES
            { folder: 'DISTRIBUTION CABLE', placemark: '-', line: '24C', polygon: '-', colorCode: '#00FF00', styleLink: '-' },
            { folder: 'DISTRIBUTION CABLE', placemark: '-', line: '36C', polygon: '-', colorCode: '#FF00FF', styleLink: '-' },
            { folder: 'DISTRIBUTION CABLE', placemark: '-', line: '48C', polygon: '-', colorCode: '#AA00FF', styleLink: '-' },
            { folder: 'DISTRIBUTION CABLE', placemark: '-', line: '72C', polygon: '-', colorCode: '#550000', styleLink: '-' },
            { folder: 'DISTRIBUTION CABLE', placemark: '-', line: '96C', polygon: '-', colorCode: '#FF0000', styleLink: '-' },
            { folder: 'DISTRIBUTION CABLE', placemark: '-', line: '144C', polygon: '-', colorCode: '#FFFF00', styleLink: '-' },
            { folder: 'DISTRIBUTION CABLE', placemark: '-', line: '288C', polygon: '-', colorCode: '#00AAFF', styleLink: '-' },
            
            // OTHERS
            { folder: 'SLING WIRE', placemark: '-', line: '-', polygon: '-', colorCode: '#00FFFF', styleLink: '-' },
            { folder: 'FDT', placemark: 'FDT', line: '-', polygon: '-', colorCode: '#AA0000', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/cross-hairs.png' },
            { folder: 'SLACK HANGER', placemark: 'SLACK', line: '-', polygon: '-', colorCode: '#ff0000', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/target.png' }
        ];

        // --- SUBFEEDER STRUCTURE ---
        const STRUCTURE_SUBFEEDER = [
            'JOINT CLOSURE', 
            'EXISTING POLE EMR 7-2.5', 'EXISTING POLE EMR 7-3', 'EXISTING POLE EMR 7-4', 
            'EXISTING POLE EMR 7-5', 'EXISTING POLE EMR 9-5', 'EXISTING POLE EMR 9-4',
            'EXISTING POLE PARTNER 7-4', 'EXISTING POLE PARTNER 9-4',
            'NEW POLE 7-5', 'NEW POLE 9-5', 'NEW POLE 7-4', 'NEW POLE 9-4',
            'CABLE', 'SLACK HANGER'
        ];

        const RULES_SUBFEEDER = [
            // Safe fallback rules for subfeeder
            { folder: 'SLACK HANGER', placemark: 'SLACK', line: '-', polygon: '-', colorCode: '#ff0000', styleLink: 'http://maps.google.com/mapfiles/kml/shapes/target.png' }
        ];

        const PROTECTED_FOLDERS = ['HP COVER', 'HP UNCOVER'];
        let kmzFile = null;
        let processedKMZ = null;

        const kmzInput = document.getElementById('kmzFile');
        const processBtn = document.getElementById('processBtn');
        const statusDiv = document.getElementById('status');
        const fileLabel = document.getElementById('fileLabel');
        const dropArea = document.getElementById('dropArea');

        function setMode(mode) {
            CURRENT_MODE = mode;
            document.querySelectorAll('.mode-option').forEach(el => el.classList.remove('active'));
            document.getElementById(`btn-${mode}`).classList.add('active');
        }

        dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('active'); });
        dropArea.addEventListener('dragleave', () => dropArea.classList.remove('active'));
        dropArea.addEventListener('drop', (e) => { e.preventDefault(); dropArea.classList.remove('active'); if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
        kmzInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });

        function handleFile(file) {
            if(!file.name.toLowerCase().endsWith('.kmz') && !file.name.toLowerCase().endsWith('.kml')) { alert('File harus .KMZ atau .KML'); return; }
            kmzFile = file;
            fileLabel.textContent = `${file.name} (${(file.size/1024).toFixed(1)} KB)`;
            fileLabel.style.color = 'var(--primary)';
            processBtn.disabled = false;
        }

        processBtn.addEventListener('click', async () => {
            if (!kmzFile) return;
            processBtn.disabled = true;
            statusDiv.innerHTML = '<span class="loading-spinner"></span>Processing...';

            try {
                let xmlDoc;
                if (kmzFile.name.toLowerCase().endsWith('.kmz')) {
                    const zip = new JSZip();
                    const contents = await zip.loadAsync(kmzFile);
                    const kmlName = Object.keys(contents.files).find(n => n.endsWith('.kml'));
                    const kmlString = await contents.files[kmlName].async('string');
                    xmlDoc = new DOMParser().parseFromString(kmlString, 'text/xml');
                } else {
                    const kmlString = await kmzFile.text();
                    xmlDoc = new DOMParser().parseFromString(kmlString, 'text/xml');
                }

                const tree = restructureKML(xmlDoc);
                applyStyles(xmlDoc);
                displayTree(tree);

                const serializer = new XMLSerializer();
                const newKml = serializer.serializeToString(xmlDoc);
                const zipOut = new JSZip();
                zipOut.file("doc.kml", newKml);
                processedKMZ = await zipOut.generateAsync({ type: 'blob' });

                statusDiv.innerHTML = '<span style="color:var(--success)">âœ… Done!</span>';
                
                const dlBtn = document.createElement('button');
                dlBtn.className = 'primary';
                dlBtn.style.marginTop = '1rem';
                dlBtn.style.background = 'var(--success)';
                dlBtn.textContent = `Download ${CURRENT_MODE.toUpperCase()} Result`;
                dlBtn.onclick = () => {
                    const url = URL.createObjectURL(processedKMZ);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `STYLED_${CURRENT_MODE.toUpperCase()}_${kmzFile.name.replace(/\.kml$/i, '.kmz')}`;
                    a.click();
                };
                statusDiv.appendChild(document.createElement('br'));
                statusDiv.appendChild(dlBtn);

            } catch (err) {
                statusDiv.innerHTML = `<span style="color:var(--error)">Error: ${err.message}</span>`;
                console.error(err);
            } finally {
                processBtn.disabled = false;
            }
        });

        document.getElementById('resetBtn').addEventListener('click', () => location.reload());

        // --- CORE LOGIC ---

        function getLineContext(placemarkNode) {
            const regex = /(?:LINE|LN|KABEL)[\s\-_]+([A-Z0-9]+)/i;
            const ignoreKeywords = ['DISTRIBUTION', 'DISTRIBUSI', 'SLACK', 'SLING', 'HANGER', 'FAT', 'FDT', 'POLE', 'TIANG', 'COVER', 'ODP', 'SPLITTER'];
            let curr = placemarkNode.parentElement;
            while (curr) {
                let name = '';
                for(let i=0; i<curr.children.length; i++) { if(curr.children[i].tagName === 'name') { name = curr.children[i].textContent.trim(); break; } }
                if (name) {
                    const upperName = name.toUpperCase();
                    const match = name.match(regex);
                    const isBlacklisted = ignoreKeywords.some(bad => upperName.includes(bad));
                    if (!isBlacklisted && match) return `LINE ${match[1].toUpperCase()}`;
                }
                if (curr.tagName === 'Document') break;
                curr = curr.parentElement;
            }
            return null;
        }

        function findFallbackGroupName(placemarkNode, structureList) {
            const ignoreList = [...structureList, 'DISTRIBUTION', 'ODP', 'SPLITTER', 'CLUSTER ID'];
            let bestName = 'LINE A'; 
            let curr = placemarkNode.parentElement;
            while (curr) {
                 let name = '';
                for(let i=0; i<curr.children.length; i++) { if(curr.children[i].tagName === 'name') { name = curr.children[i].textContent.trim(); break; } }
                if (name && curr.tagName === 'Folder') {
                    const upper = name.toUpperCase();
                    const isStandard = ignoreList.some(s => upper.includes(s));
                    if (!isStandard) bestName = name; 
                }
                if (curr.tagName === 'Document' || (name && name.toUpperCase().includes('CLUSTER ID'))) break;
                curr = curr.parentElement;
            }
            return bestName;
        }

        function restructureKML(xmlDoc) {
            const kmlDoc = xmlDoc.querySelector('Document');
            const targetStructure = (CURRENT_MODE === 'subfeeder') ? STRUCTURE_SUBFEEDER : STRUCTURE_CLUSTER;

            let boundaryClusterNode = null;
            const allFolders = Array.from(xmlDoc.querySelectorAll('Folder'));
            const boundaryOriginal = allFolders.find(f => f.querySelector('name')?.textContent?.toUpperCase().includes('BOUNDARY CLUSTER'));
            if (boundaryOriginal) boundaryClusterNode = boundaryOriginal.cloneNode(true);

            const allPlacemarks = Array.from(xmlDoc.querySelectorAll('Placemark')).filter(pm => {
                if (boundaryOriginal && boundaryOriginal.contains(pm)) return false;
                return true;
            });

            const fdtBucket = []; 
            const lineBuckets = {}; 
            const othersBucket = [];

            const addToLineBucket = (lineName, folderName, item, subFolderName = null) => {
                if (!lineBuckets[lineName]) lineBuckets[lineName] = {};
                if (!lineBuckets[lineName][folderName]) lineBuckets[lineName][folderName] = {};
                const subKey = subFolderName || 'MAIN';
                if (!lineBuckets[lineName][folderName][subKey]) lineBuckets[lineName][folderName][subKey] = [];
                lineBuckets[lineName][folderName][subKey].push(item);
            };

            const strictCableRegex = /\b\d{2,3}C\/\d{1,2}T\b/i;

            allPlacemarks.forEach(pm => {
                const name = (pm.querySelector('name')?.textContent || '').toUpperCase();
                const desc = (pm.querySelector('description')?.textContent || '').toUpperCase();
                const fullText = name + ' ' + desc;
                
                const isLine = pm.querySelector('LineString') !== null;
                const parentFolder = pm.parentElement;
                const parentName = (parentFolder.querySelector('name')?.textContent || '').toUpperCase();
                const grandParentName = (parentFolder.parentElement?.querySelector('name')?.textContent || '').toUpperCase();
                
                let lineName = 'MAIN';
                if (CURRENT_MODE === 'cluster') {
                    lineName = getLineContext(pm);
                    if (!lineName) lineName = findFallbackGroupName(pm, targetStructure);
                }

                let targetType = 'UNKNOWN';
                let subFolderName = null;

                // PROTECTED FOLDERS (V22/V23 Fix)
                if (parentName.includes('HP COVER')) { targetType = 'HP COVER'; } 
                else if (grandParentName.includes('HP COVER')) { targetType = 'HP COVER'; subFolderName = parentName; } 
                else if (parentName.includes('HP UNCOVER')) targetType = 'HP UNCOVER';
                else if (grandParentName.includes('HP UNCOVER')) { targetType = 'HP UNCOVER'; subFolderName = parentName; }
                
                if (targetType === 'UNKNOWN') {
                    if (CURRENT_MODE === 'subfeeder') {
                        if (isLine && (strictCableRegex.test(fullText) || name.includes('CABLE'))) { targetType = 'CABLE'; }
                        else if (!isLine && (name.includes('JC') || fullText.includes('JOINT CLOSURE') || /\b(288C|144C|96C|72C|48C)\b/.test(fullText))) { targetType = 'JOINT CLOSURE'; }
                        else {
                            const poleMatch = targetStructure.find(type => type.includes('POLE') && (name.includes(type) || parentName.includes(type)));
                            if (poleMatch) targetType = poleMatch;
                        }
                    } else {
                        // Cluster Mode
                        if (!isLine && (name.includes('FDT') || desc.includes('FDT') || (/\b(288C|144C|96C|72C|48C)\b/.test(fullText) && !strictCableRegex.test(fullText)))) { targetType = 'FDT_GLOBAL'; }
                        else if (isLine && (strictCableRegex.test(fullText) || name.includes('CABLE'))) targetType = 'DISTRIBUTION CABLE';
                        else {
                             const match = targetStructure.find(type => name.includes(type) || parentName.includes(type));
                             if (match) targetType = match;
                        }
                    }
                }

                if (targetType === 'UNKNOWN') {
                    if (name.includes('SLING')) targetType = (CURRENT_MODE === 'subfeeder') ? 'UNKNOWN' : 'SLING WIRE';
                    else if (name.includes('SLACK')) targetType = 'SLACK HANGER';
                    else {
                        const match = targetStructure.find(type => name.includes(type) || parentName.includes(type));
                        if(match) targetType = match;
                    }
                }

                pm.remove();
                if (targetType === 'FDT_GLOBAL' && CURRENT_MODE === 'cluster') fdtBucket.push(pm);
                else if (targetType !== 'UNKNOWN') addToLineBucket(lineName, targetType, pm, subFolderName);
                else othersBucket.push(pm);
            });

            while (kmlDoc.firstChild) kmlDoc.removeChild(kmlDoc.firstChild);
            const root = xmlDoc.createElement('Folder');
            root.appendChild(createName(xmlDoc, (CURRENT_MODE === 'subfeeder') ? 'SUBFEEDER ID' : 'CLUSTER ID'));

            if (boundaryClusterNode) root.appendChild(boundaryClusterNode);
            if (fdtBucket.length > 0) root.appendChild(createFolder(xmlDoc, 'FDT', fdtBucket));

            if (CURRENT_MODE === 'subfeeder') {
                const mainData = lineBuckets['MAIN'] || {};
                targetStructure.forEach(folderName => {
                    const subData = mainData[folderName];
                    if (subData) {
                        const folder = xmlDoc.createElement('Folder');
                        folder.appendChild(createName(xmlDoc, folderName));
                        if (subData['MAIN']) subData['MAIN'].forEach(i => folder.appendChild(i));
                        Object.keys(subData).forEach(k => { if (k !== 'MAIN') folder.appendChild(createFolder(xmlDoc, k, subData[k])); });
                        root.appendChild(folder);
                    } else { root.appendChild(createFolder(xmlDoc, folderName, [])); }
                });
            } else {
                Object.keys(lineBuckets).sort().forEach(ln => {
                    const lnFolder = xmlDoc.createElement('Folder');
                    lnFolder.appendChild(createName(xmlDoc, ln));
                    targetStructure.forEach(folderName => {
                        const subData = lineBuckets[ln][folderName];
                        if (subData) {
                            const folder = xmlDoc.createElement('Folder');
                            folder.appendChild(createName(xmlDoc, folderName));
                            if (subData['MAIN']) subData['MAIN'].forEach(i => folder.appendChild(i));
                            Object.keys(subData).forEach(k => { if (k !== 'MAIN') folder.appendChild(createFolder(xmlDoc, k, subData[k])); });
                            lnFolder.appendChild(folder);
                        } else { lnFolder.appendChild(createFolder(xmlDoc, folderName, [])); }
                    });
                    root.appendChild(lnFolder);
                });
            }

            if (othersBucket.length > 0) root.appendChild(createFolder(xmlDoc, 'OTHERS', othersBucket));
            kmlDoc.appendChild(root);

            return { mode: CURRENT_MODE, lines: Object.keys(lineBuckets) };
        }

        function createName(xml, text) { const n = xml.createElement('name'); n.textContent = text; return n; }
        function createFolder(xml, name, items) { 
            const f = xml.createElement('Folder'); 
            f.appendChild(createName(xml, name)); 
            items.forEach(i => f.appendChild(i)); 
            return f; 
        }

        function applyStyles(xmlDoc) {
            const placemarks = xmlDoc.querySelectorAll('Placemark');
            const doc = xmlDoc.querySelector('Document');
            const stylesCreated = new Set();

            const styleB = xmlDoc.createElement('Style'); styleB.id = 'style_boundary';
            styleB.innerHTML = `<LineStyle><color>4dffffff</color><width>2</width></LineStyle><PolyStyle><color>4dffffff</color></PolyStyle>`;
            doc.appendChild(styleB);

            placemarks.forEach(pm => {
                const name = (pm.querySelector('name')?.textContent || '').toUpperCase();
                const desc = (pm.querySelector('description')?.textContent || '').toUpperCase();
                const fullText = name + ' ' + desc;
                const folderName = pm.parentElement.querySelector('name')?.textContent || '';
                const grandParentName = pm.parentElement.parentElement?.querySelector('name')?.textContent || '';

                // FIX V25: BOUNDARY CLUSTER ONLY
                if (folderName.includes('BOUNDARY CLUSTER')) { setStyle(pm, 'style_boundary'); return; }

                let rule = null;

                if (CURRENT_MODE === 'cluster') {
                    // --- CLUSTER LOGIC ---
                    rule = RULES_CLUSTER.find(r => {
                        if (r.folder !== '-' && r.folder === folderName) return true;
                        if (folderName === 'DISTRIBUTION CABLE' && r.line !== '-' && fullText.includes(r.line)) return true;
                        if (r.placemark !== '-' && fullText.includes(r.placemark)) return true;
                        return false;
                    });
                    
                    // FIX V25: HP COVER SUBFOLDER FALLBACK (Grandparent Check)
                    if (!rule) {
                        if (grandParentName.includes('HP COVER')) rule = RULES_CLUSTER.find(r => r.folder === 'HP COVER');
                        else if (grandParentName.includes('HP UNCOVER')) rule = RULES_CLUSTER.find(r => r.folder === 'HP UNCOVER');
                    }

                } else {
                    // --- SUBFEEDER LOGIC ---
                    if (folderName === 'CABLE') {
                        const coreColors = { '288C': '#FFAA00', '144C': '#FFFF00', '96C': '#FF0000', '48C': '#AA00FF' };
                        const match = Object.keys(coreColors).find(k => fullText.includes(k));
                        rule = { colorCode: match ? coreColors[match] : '#00AAFF', styleLink: '-', placemark: '-' };
                    }
                    else if (folderName === 'JOINT CLOSURE') {
                        const isJC = name.includes('JC');
                        const coreMatch = fullText.match(/\b(\d+)C\b/);
                        const core = coreMatch ? coreMatch[0] : '48C';
                        const coreMap = { '288C': '#FFAA00', '144C': '#550000', '96C': '#FF0000', '72C': '#0000FF', '48C': '#AA00FF', '36C': '#FF00FF', '24C': '#00FF00' };
                        const color = coreMap[core] || '#AA00FF';
                        
                        if (isJC) rule = { colorCode: color, styleLink: 'http://maps.google.com/mapfiles/kml/shapes/forbidden.png', placemark: 'JC_' + core };
                        else rule = { colorCode: color, styleLink: 'http://maps.google.com/mapfiles/kml/shapes/cross-hairs.png', placemark: 'FDT_' + core };
                    }
                    else if (folderName.includes('POLE')) {
                        // --- LOGIC BARU (FIXED POLE COLOR SUBFEEDER) ---
                        let pColor = '#550000'; // Default Existing (Coklat)
                        const upperFolder = folderName.toUpperCase();

                        if (upperFolder.includes('NEW')) {
                            if (upperFolder.includes('9-')) pColor = '#FF0000'; // 9m New
                            else if (upperFolder.includes('7-5') || upperFolder.includes('7-4')) pColor = '#00FF00'; // 7m Standard New
                            else if (upperFolder.includes('7-3')) pColor = '#00FFFF'; // 7m 7-3 New
                            else if (upperFolder.includes('7-2.5')) pColor = '#AA00FF'; // 7m 7-2.5 New
                        }

                        rule = { colorCode: pColor, styleLink: 'http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png', placemark: '-' };
                    }
                    else {
                        rule = RULES_SUBFEEDER.find(r => r.folder === folderName);
                    }
                }

                if (rule) {
                    const safeName = rule.placemark !== '-' ? rule.placemark : folderName;
                    const styleId = `style_${rule.colorCode.replace('#','')}_${safeName.replace(/[^a-z0-9]/gi,'')}_${Math.floor(Math.random()*1000)}`;
                    
                    if (!stylesCreated.has(styleId)) {
                        const style = xmlDoc.createElement('Style'); style.id = styleId;
                        const kmlColor = 'ff' + rule.colorCode.replace('#', '').match(/.{2}/g).reverse().join('');
                        let styleContent = `<LabelStyle><color>${kmlColor}</color><scale>${TEXT_SIZE}</scale></LabelStyle>`;
                        if (rule.styleLink !== '-') styleContent += `<IconStyle><color>${kmlColor}</color><scale>1.1</scale><Icon><href>${rule.styleLink}</href></Icon></IconStyle>`;
                        styleContent += `<LineStyle><color>${kmlColor}</color><width>2</width></LineStyle><PolyStyle><color>66${kmlColor.substring(2)}</color></PolyStyle>`;
                        style.innerHTML = styleContent;
                        doc.appendChild(style);
                        stylesCreated.add(styleId);
                    }
                    setStyle(pm, styleId);
                }
            });
        }

        function setStyle(pm, id) {
            let url = pm.querySelector('styleUrl');
            if (!url) { url = pm.ownerDocument.createElement('styleUrl'); pm.appendChild(url); }
            url.textContent = '#' + id;
        }

        function displayTree(result) {
            const list = document.getElementById('folderList');
            const mode = result.mode;
            let html = `<div class="tree-item"><span class="tree-folder" style="color:#aaa">BOUNDARY CLUSTER</span></div>`;
            if (result.lines.includes('FDT') || mode === 'cluster') html += `<div class="tree-item"><span class="tree-folder">FDT</span></div>`;
            
            if (mode === 'subfeeder') {
                html += `<div class="tree-item"><span class="tree-folder">SUBFEEDER ID</span></div>`;
                STRUCTURE_SUBFEEDER.forEach(f => {
                    html += `<div class="tree-item" style="margin-left:20px; font-size:0.9em; color:#888">${f}</div>`;
                });
            } else {
                result.lines.forEach(l => {
                    html += `<div class="tree-item"><span class="tree-folder">${l}</span></div>`;
                });
            }
            list.innerHTML = html;
            document.getElementById('preview').classList.remove('hidden');
        }
    </script>
</body>
</html>
