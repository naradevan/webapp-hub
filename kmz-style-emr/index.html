<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMZ Styler EMR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* --- UI STYLE DARI FILE UPLOADAN LU (V12 STYLE) --- */
        :root {
            --bg-body: #0d0d0d;
            --bg-surface: #171717;
            --bg-surface-hover: #222;
            --border: #333;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --text-main: #ededed;
            --text-muted: #888;
            --success: #22c55e;
            --error: #ef4444;
            --radius: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding-top: 5vh;
        }

        .container {
            width: 100%;
            max-width: 680px;
            padding: 0 1.5rem;
        }

        header { margin-bottom: 2rem; text-align: center; }
        h1 {
            font-size: 1.75rem;
            font-weight: 600;
            letter-spacing: -0.03em;
            margin-bottom: 0.5rem;
            background: linear-gradient(to bottom right, #fff, #888);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { color: var(--text-muted); font-size: 0.95rem; }

        .card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
        }

        /* TOGGLE SWITCH */
        .mode-selector {
            display: flex;
            background: #222;
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        .mode-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-muted);
            border-radius: 6px;
            transition: all 0.2s;
        }
        .mode-option.active {
            color: #fff;
            background: var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .file-drop-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255,255,255,0.01);
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
            color: var(--text-muted);
        }
        .file-drop-area:hover { border-color: var(--primary); background: rgba(59, 130, 246, 0.05); color: var(--text-main); }
        .file-drop-area.active { border-color: var(--success); background: rgba(34, 197, 94, 0.05); }
        #fileLabel { font-size: 0.95rem; pointer-events: none; transition: color 0.2s; }
        input[type="file"] { display: none; }

        .btn-group { display: flex; gap: 10px; justify-content: center; }
        button { padding: 0.75rem 1.5rem; border-radius: 6px; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; }
        button.primary { background: var(--primary); color: white; box-shadow: 0 2px 10px rgba(59, 130, 246, 0.2); }
        button.primary:hover:not(:disabled) { background: var(--primary-hover); transform: translateY(-1px); }
        button.primary:disabled { background: var(--bg-surface-hover); color: var(--text-muted); cursor: not-allowed; box-shadow: none; }
        button.secondary { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        button.secondary:hover { border-color: var(--text-muted); background: var(--bg-surface-hover); }

        #status { margin-top: 1.5rem; font-size: 0.9rem; text-align: center; min-height: 24px; }
        .folder-list { background: #111; border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; max-height: 400px; overflow-y: auto; font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 0.85rem; }
        .tree-item { margin-left: 1.5rem; border-left: 1px solid #333; padding-left: 0.75rem; margin-bottom: 0.25rem; position: relative; }
        .tree-folder { color: #fbbf24; font-weight: 600; }
        .tree-subfolder { color: #4ade80; }
        .tree-info { color: #666; font-size: 0.8em; margin-left: 0.5rem; }
        .hidden { display: none; }
        .loading-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: text-bottom; }
        @keyframes spin { to { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>KMZ Styler EMR</h1>
            <p class="subtitle">Update 30/12/2025</p>
        </header>

        <div class="card">
            <div class="mode-selector">
                <div class="mode-option active" onclick="setMode('cluster')" id="btn-cluster">CLUSTER MODE</div>
                <div class="mode-option" onclick="setMode('subfeeder')" id="btn-subfeeder">SUBFEEDER MODE</div>
            </div>

            <label class="file-drop-area" id="dropArea">
                <span id="fileLabel">Drag & drop KMZ/KML here or click to upload</span>
                <input type="file" id="kmzFile" accept=".kmz, .kml" />
            </label>

            <div class="btn-group">
                <button id="processBtn" class="primary" disabled>Process File</button>
                <button id="resetBtn" class="secondary">Reset</button>
            </div>
            
            <div id="status"></div>
        </div>

        <div id="preview" class="hidden">
            <div class="card" style="padding: 1rem;">
                <h3 style="font-size: 0.9rem; margin-bottom: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Structure Preview</h3>
                <div class="folder-list" id="folderList"></div>
            </div>
        </div>
    </div>

    <script>
        let CURRENT_MODE = 'cluster'; // Default

        // --- 1. CLUSTER SETUP ---
        const STRUCTURE_CLUSTER = [
            'BOUNDARY FAT', 'FAT', 'HP COVER', 'HP UNCOVER',
            'EXISTING POLE EMR 7-2.5', 'EXISTING POLE EMR 7-3', 'EXISTING POLE EMR 7-4', 'EXISTING POLE EMR 9-4',
            'EXISTING POLE PARTNER 7-4', 'EXISTING POLE PARTNER 9-4',
            'NEW POLE 7-2.5', 'NEW POLE 7-3', 'NEW POLE 7-4', 'NEW POLE 9-4',
            'DISTRIBUTION CABLE', 'SLACK HANGER', 'SLING WIRE'
        ];

        // --- 2. SUBFEEDER SETUP (No FDT Folder, No Sling Wire) ---
        const STRUCTURE_SUBFEEDER = [
            'JOINT CLOSURE', // JC & FDT masuk sini
            'EXISTING POLE EMR 7-2.5', 
            'EXISTING POLE EMR 7-3', 
            'EXISTING POLE EMR 7-4', 
            'EXISTING POLE EMR 7-5', // Added
            'EXISTING POLE EMR 9-5', // Added
            'EXISTING POLE EMR 9-4',
            'EXISTING POLE PARTNER 7-4', 
            'EXISTING POLE PARTNER 9-4',
            'NEW POLE 7-5', // Added
            'NEW POLE 9-5', // Added
            'NEW POLE 7-4', 
            'NEW POLE 9-4',
            'CABLE',
            'SLACK HANGER'
        ];

        const PROTECTED_FOLDERS = ['HP COVER', 'HP UNCOVER'];

        // --- STYLING RULES ---
        const RULES_COMMON = [
            // CABLE (Global)
            { type: 'cable', name: '288C', color: '#FFAA00' },
            { type: 'cable', name: '144C', color: '#FFFF00' },
            { type: 'cable', name: '96C', color: '#FF0000' },
            { type: 'cable', name: '72C', color: '#550000' },
            { type: 'cable', name: '48C', color: '#AA00FF' },
            { type: 'cable', name: '36C', color: '#FF00FF' },
            { type: 'cable', name: '24C', color: '#00FF00' },
            { type: 'cable', name: '12C', color: '#00FFFF' },

            // JC (Kotak - Link 6)
            { type: 'jc', name: '288C', color: '#FFAA00' },
            { type: 'jc', name: '144C', color: '#FFFF00' },
            { type: 'jc', name: '96C', color: '#FF0000' },
            { type: 'jc', name: '72C', color: '#550000' },
            { type: 'jc', name: '48C', color: '#AA00FF' },
            { type: 'jc', name: '36C', color: '#FF00FF' },
            { type: 'jc', name: '24C', color: '#00FF00' },

            // FDT (Bulat - Link 3)
            { type: 'fdt', name: '288C', color: '#AA0000' },
            { type: 'fdt', name: '144C', color: '#FFFF00' },
            { type: 'fdt', name: '96C', color: '#00FFFF' },
            { type: 'fdt', name: '72C', color: '#0000FF' },
            { type: 'fdt', name: '48C', color: '#AA00FF' },

            // POLES (General Mapping)
            { type: 'pole', name: 'NEW POLE 9-4', color: '#FF0000' }, // Override in Subfeeder if needed
            { type: 'pole', name: 'NEW POLE 7-4', color: '#00FF00' },
            { type: 'pole', name: 'NEW POLE 7-3', color: '#00FFFF' },
            { type: 'pole', name: 'NEW POLE 7-2.5', color: '#AA00FF' },
            { type: 'pole', name: 'EXISTING', color: '#550000' } // Fallback for all existing
        ];

        let kmzFile = null;
        let processedKMZ = null;

        // UI Handlers
        function setMode(mode) {
            CURRENT_MODE = mode;
            document.querySelectorAll('.mode-option').forEach(el => el.classList.remove('active'));
            document.getElementById(`btn-${mode}`).classList.add('active');
        }

        const dropArea = document.getElementById('dropArea');
        const kmzInput = document.getElementById('kmzFile');
        const processBtn = document.getElementById('processBtn');
        const statusDiv = document.getElementById('status');
        const fileLabel = document.getElementById('fileLabel');

        dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('active'); });
        dropArea.addEventListener('dragleave', () => dropArea.classList.remove('active'));
        dropArea.addEventListener('drop', (e) => { e.preventDefault(); dropArea.classList.remove('active'); if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
        kmzInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });

        function handleFile(file) {
            if(!file.name.toLowerCase().endsWith('.kmz') && !file.name.toLowerCase().endsWith('.kml')) { alert('File harus .KMZ atau .KML'); return; }
            kmzFile = file;
            fileLabel.textContent = `${file.name} (${(file.size/1024).toFixed(1)} KB)`;
            fileLabel.style.color = 'var(--primary)';
            processBtn.disabled = false;
        }

        processBtn.addEventListener('click', async () => {
            if (!kmzFile) return;
            processBtn.disabled = true;
            statusDiv.innerHTML = '<span class="loading-spinner"></span>Processing...';

            try {
                let xmlDoc;
                if (kmzFile.name.toLowerCase().endsWith('.kmz')) {
                    const zip = new JSZip();
                    const contents = await zip.loadAsync(kmzFile);
                    const kmlName = Object.keys(contents.files).find(n => n.endsWith('.kml'));
                    const kmlString = await contents.files[kmlName].async('string');
                    xmlDoc = new DOMParser().parseFromString(kmlString, 'text/xml');
                } else {
                    const kmlString = await kmzFile.text();
                    xmlDoc = new DOMParser().parseFromString(kmlString, 'text/xml');
                }

                // 1. RESTRUCTURE (Distribute items to folders)
                const tree = restructureKML(xmlDoc);
                
                // 2. APPLY STYLES (Apply icons/colors)
                applyStyles(xmlDoc);

                // 3. DISPLAY
                displayTree(tree);

                // 4. EXPORT
                const serializer = new XMLSerializer();
                const newKml = serializer.serializeToString(xmlDoc);
                const zipOut = new JSZip();
                zipOut.file("doc.kml", newKml);
                processedKMZ = await zipOut.generateAsync({ type: 'blob' });

                statusDiv.innerHTML = '<span style="color:var(--success)">âœ… Done!</span>';
                
                const dlBtn = document.createElement('button');
                dlBtn.className = 'primary';
                dlBtn.style.marginTop = '1rem';
                dlBtn.style.background = 'var(--success)';
                dlBtn.textContent = `Download ${CURRENT_MODE.toUpperCase()} Result`;
                dlBtn.onclick = () => {
                    const url = URL.createObjectURL(processedKMZ);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `STYLED_${CURRENT_MODE.toUpperCase()}_${kmzFile.name.replace(/\.kml$/i, '.kmz')}`;
                    a.click();
                };
                statusDiv.appendChild(document.createElement('br'));
                statusDiv.appendChild(dlBtn);

            } catch (err) {
                statusDiv.innerHTML = `<span style="color:var(--error)">Error: ${err.message}</span>`;
                console.error(err);
            } finally {
                processBtn.disabled = false;
            }
        });

        document.getElementById('resetBtn').addEventListener('click', () => location.reload());

        // ==========================================
        //       CORE LOGIC (V19 BRAIN)
        // ==========================================

        function restructureKML(xmlDoc) {
            const kmlDoc = xmlDoc.querySelector('Document');
            const targetStructure = (CURRENT_MODE === 'subfeeder') ? STRUCTURE_SUBFEEDER : STRUCTURE_CLUSTER;

            // 1. Safeguard Boundary
            let boundaryClusterNode = null;
            const allFolders = Array.from(xmlDoc.querySelectorAll('Folder'));
            const boundaryOriginal = allFolders.find(f => f.querySelector('name')?.textContent?.toUpperCase().includes('BOUNDARY CLUSTER'));
            if (boundaryOriginal) boundaryClusterNode = boundaryOriginal.cloneNode(true);

            // 2. Collect Items (excluding Boundary)
            const allPlacemarks = Array.from(xmlDoc.querySelectorAll('Placemark')).filter(pm => {
                if (boundaryOriginal && boundaryOriginal.contains(pm)) return false;
                return true;
            });

            // Buckets
            const fdtBucket = []; // Only used in Cluster Mode
            const lineBuckets = {}; // Main organizer
            const othersBucket = [];

            const addToLineBucket = (lineName, folderName, item) => {
                if (!lineBuckets[lineName]) lineBuckets[lineName] = {};
                if (!lineBuckets[lineName][folderName]) lineBuckets[lineName][folderName] = [];
                lineBuckets[lineName][folderName].push(item);
            };

            // REGEX for Cable: "24C/2T" or similar
            const strictCableRegex = /\b\d{2,3}C\/\d{1,2}T\b/i;

            allPlacemarks.forEach(pm => {
                const name = (pm.querySelector('name')?.textContent || '').toUpperCase();
                const desc = (pm.querySelector('description')?.textContent || '').toUpperCase();
                const fullText = name + ' ' + desc; // GABUNGAN NAMA + DESKRIPSI UNTUK CEK LEBIH TELITI

                const parentFolder = pm.parentElement;
                const parentName = (parentFolder.querySelector('name')?.textContent || '').toUpperCase();
                
                // Determine Line Name (Cluster only)
                let lineName = 'MAIN';
                if (CURRENT_MODE === 'cluster') {
                    // (Logic deteksi Line A/B standard)
                    const lineMatch = parentName.match(/(?:LINE|LN|KABEL)[\s\-_]+([A-Z0-9]+)/i);
                    if (lineMatch) lineName = `LINE ${lineMatch[1]}`;
                    else lineName = 'LINE A';
                }

                // DETECT TARGET FOLDER
                let targetType = 'UNKNOWN';

                // Check Protected Folders (HP Cover)
                if (parentName.includes('HP COVER')) targetType = 'HP COVER';
                else if (parentName.includes('HP UNCOVER')) targetType = 'HP UNCOVER';
                
                if (targetType === 'UNKNOWN') {
                    if (CURRENT_MODE === 'subfeeder') {
                        // --- SUBFEEDER LOGIC (V19) ---
                        
                        // 1. CABLE (Cek Strict)
                        if (strictCableRegex.test(fullText) || name.includes('CABLE')) {
                            targetType = 'CABLE';
                        }
                        // 2. JOINT CLOSURE (Cek Nama)
                        else if (name.includes('JC') || fullText.includes('JOINT CLOSURE')) {
                            targetType = 'JOINT CLOSURE';
                        }
                        // 3. FDT / Splice (Cek Full Text for Core Count) -> MASUK FOLDER JOINT CLOSURE
                        else if (/\b(288C|144C|96C|72C|48C)\b/.test(fullText)) {
                            targetType = 'JOINT CLOSURE';
                        }
                        // 4. POLES
                        else {
                            // Cek satu-satu rule pole
                            const poleMatch = targetStructure.find(type => type.includes('POLE') && (name.includes(type) || parentName.includes(type)));
                            if (poleMatch) targetType = poleMatch;
                        }

                    } else {
                        // --- CLUSTER LOGIC ---
                        if (name.includes('FDT') || desc.includes('FDT')) targetType = 'FDT_GLOBAL'; // Masuk bucket khusus
                        else if (strictCableRegex.test(fullText) || name.includes('CABLE')) targetType = 'DISTRIBUTION CABLE';
                        else {
                             // Standard matching
                             const match = targetStructure.find(type => name.includes(type) || parentName.includes(type));
                             if (match) targetType = match;
                        }
                    }
                }

                // Fallback / Others
                if (targetType === 'UNKNOWN') {
                    if (name.includes('SLING')) targetType = (CURRENT_MODE === 'subfeeder') ? 'UNKNOWN' : 'SLING WIRE';
                    else if (name.includes('SLACK')) targetType = 'SLACK HANGER';
                }

                // MOVE ITEM
                pm.remove();
                if (targetType === 'FDT_GLOBAL') fdtBucket.push(pm);
                else if (targetType !== 'UNKNOWN') addToLineBucket(lineName, targetType, pm);
                else othersBucket.push(pm);
            });

            // 3. Reconstruct XML
            while (kmlDoc.firstChild) kmlDoc.removeChild(kmlDoc.firstChild);
            const root = xmlDoc.createElement('Folder');
            const rootName = xmlDoc.createElement('name');
            rootName.textContent = (CURRENT_MODE === 'subfeeder') ? 'SUBFEEDER ID' : 'CLUSTER ID';
            root.appendChild(rootName);

            if (boundaryClusterNode) root.appendChild(boundaryClusterNode);
            if (fdtBucket.length > 0) root.appendChild(createFolder(xmlDoc, 'FDT', fdtBucket));

            if (CURRENT_MODE === 'subfeeder') {
                // Flat Structure
                const mainData = lineBuckets['MAIN'] || {};
                targetStructure.forEach(folderName => {
                    const items = mainData[folderName] || [];
                    root.appendChild(createFolder(xmlDoc, folderName, items));
                });
            } else {
                // Nested Structure
                Object.keys(lineBuckets).sort().forEach(ln => {
                    const lnFolder = xmlDoc.createElement('Folder');
                    const lnName = xmlDoc.createElement('name'); lnName.textContent = ln; lnFolder.appendChild(lnName);
                    
                    targetStructure.forEach(folderName => {
                        const items = lineBuckets[ln][folderName] || [];
                        lnFolder.appendChild(createFolder(xmlDoc, folderName, items));
                    });
                    root.appendChild(lnFolder);
                });
            }

            if (othersBucket.length > 0) root.appendChild(createFolder(xmlDoc, 'OTHERS', othersBucket));
            kmlDoc.appendChild(root);

            return { mode: CURRENT_MODE, lines: Object.keys(lineBuckets) };
        }

        function createFolder(xml, name, items) {
            const f = xml.createElement('Folder');
            const n = xml.createElement('name'); n.textContent = name; f.appendChild(n);
            items.forEach(i => f.appendChild(i));
            return f;
        }

        // ==========================================
        //       STYLING LOGIC (V19)
        // ==========================================

        function applyStyles(xmlDoc) {
            const placemarks = xmlDoc.querySelectorAll('Placemark');
            const doc = xmlDoc.querySelector('Document');
            
            // Add Boundary Style
            const styleB = xmlDoc.createElement('Style'); styleB.id = 'style_boundary';
            styleB.innerHTML = `<LineStyle><color>4dffffff</color><width>2</width></LineStyle><PolyStyle><color>4dffffff</color></PolyStyle>`;
            doc.appendChild(styleB);

            placemarks.forEach(pm => {
                const name = (pm.querySelector('name')?.textContent || '').toUpperCase();
                const desc = (pm.querySelector('description')?.textContent || '').toUpperCase();
                const fullText = name + ' ' + desc;
                const folderName = pm.parentElement.querySelector('name')?.textContent || '';

                // Handle Boundary
                if (folderName.includes('BOUNDARY')) {
                    setStyle(pm, 'style_boundary'); return;
                }

                let color = '#FFFFFF';
                let icon = ''; // Link icon
                let type = 'unknown';

                // --- LOGIC DETEKSI STYLE ---

                if (CURRENT_MODE === 'subfeeder') {
                    // SUBFEEDER RULES
                    if (folderName === 'CABLE') {
                        type = 'cable';
                    } 
                    else if (folderName === 'JOINT CLOSURE') {
                        // *CRITICAL LOGIC V19*
                        // 1. Cek Nama dulu buat JC
                        if (name.includes('JC')) {
                            type = 'jc';
                        }
                        // 2. Cek Desc/Name buat FDT
                        else if (fullText.includes('FDT') || /\b\d+C\b/.test(fullText)) {
                            type = 'fdt'; // Gunakan icon bulat
                        }
                        else {
                            type = 'jc'; // Default ke JC kalau di folder JC
                        }
                    }
                    else if (folderName.includes('POLE')) {
                        type = 'pole';
                        color = '#550000'; // All Subfeeder poles are Brown
                        icon = 'http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png';
                    }
                } else {
                    // CLUSTER RULES
                    if (folderName.includes('DISTRIBUTION')) type = 'cable';
                    else if (folderName === 'FDT') type = 'fdt';
                    else if (folderName.includes('POLE')) type = 'pole_cluster';
                }

                // --- RESOLVE COLOR & ICON ---
                
                // Specific Core Colors
                const coreColors = [
                    { k: '288C', c: '#AA0000' }, // Merah Tua
                    { k: '144C', c: '#FFFF00' }, // Kuning
                    { k: '96C', c: '#00FFFF' },  // Cyan
                    { k: '72C', c: '#0000FF' },  // Biru
                    { k: '48C', c: '#AA00FF' },  // Ungu
                    { k: '24C', c: '#00FF00' },  // Hijau
                ];

                // 1. CABLE / JC / FDT COLOR MATCHING
                if (['cable', 'jc', 'fdt'].includes(type)) {
                    const match = coreColors.find(m => fullText.includes(m.k));
                    if (match) color = match.c;
                    else if (type === 'cable') color = '#00AAFF'; // Default Cable
                    else if (type === 'jc') color = '#FFAA00';    // Default JC
                    else if (type === 'fdt') color = '#AA0000';   // Default FDT
                }

                // 2. ICON ASSIGNMENT
                if (type === 'jc') icon = 'http://maps.google.com/mapfiles/kml/shapes/forbidden.png'; // Kotak
                else if (type === 'fdt') icon = 'http://maps.google.com/mapfiles/kml/shapes/cross-hairs.png'; // Bulat
                
                // 3. POLE CLUSTER COLORS (Special)
                if (type === 'pole_cluster') {
                    icon = 'http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png';
                    if (name.includes('9-4')) color = '#FF0000'; // Merah
                    else if (name.includes('7-4')) color = '#00FF00'; // Hijau
                    else if (name.includes('7-3')) color = '#00FFFF'; // Cyan
                    else if (name.includes('7-2.5')) color = '#AA00FF'; // Ungu
                    else color = '#550000'; // Coklat (Existing)
                }

                // 4. OTHER FOLDERS
                if (folderName === 'HP COVER') { color = '#00FF00'; icon = 'http://maps.google.com/mapfiles/kml/shapes/homegardenbusiness.png'; }
                else if (folderName === 'HP UNCOVER') { color = '#FF0000'; icon = 'http://maps.google.com/mapfiles/kml/shapes/homegardenbusiness.png'; }
                else if (folderName === 'SLACK HANGER') { color = '#FF0000'; icon = 'http://maps.google.com/mapfiles/kml/shapes/target.png'; }
                else if (folderName === 'SLING WIRE') { color = '#00FFFF'; }

                // --- APPLY TO XML ---
                const styleId = `style_${Math.floor(Math.random()*99999)}`;
                const styleEl = xmlDoc.createElement('Style'); styleEl.id = styleId;
                
                const kmlColor = 'ff' + color.replace('#', '').match(/.{2}/g).reverse().join(''); // Hex to KML AABBGGRR
                
                let styleContent = '';
                // Icon Style
                if (icon) {
                    styleContent += `<IconStyle><color>${kmlColor}</color><scale>1.1</scale><Icon><href>${icon}</href></Icon></IconStyle>`;
                }
                // Line Style
                styleContent += `<LineStyle><color>${kmlColor}</color><width>2</width></LineStyle>`;
                // Poly Style
                styleContent += `<PolyStyle><color>66${kmlColor.substring(2)}</color></PolyStyle>`;
                // Label Style
                styleContent += `<LabelStyle><color>${kmlColor}</color></LabelStyle>`;

                styleEl.innerHTML = styleContent;
                doc.appendChild(styleEl);
                
                let url = pm.querySelector('styleUrl');
                if (!url) { url = xmlDoc.createElement('styleUrl'); pm.appendChild(url); }
                url.textContent = '#' + styleId;
            });
        }

        function setStyle(pm, id) {
            let url = pm.querySelector('styleUrl');
            if (!url) { url = pm.ownerDocument.createElement('styleUrl'); pm.appendChild(url); }
            url.textContent = '#' + id;
        }

        function displayTree(result) {
            const list = document.getElementById('folderList');
            const mode = result.mode;
            let html = '';
            
            if (mode === 'subfeeder') {
                html += `<div class="tree-item"><span class="tree-folder">SUBFEEDER ID</span></div>`;
                STRUCTURE_SUBFEEDER.forEach(f => {
                    html += `<div class="tree-item" style="margin-left:20px; font-size:0.9em; color:#888">${f}</div>`;
                });
            } else {
                result.lines.forEach(l => {
                    html += `<div class="tree-item"><span class="tree-folder">${l}</span></div>`;
                });
            }
            list.innerHTML = html;
            document.getElementById('preview').classList.remove('hidden');
        }

    </script>
</body>
</html>

