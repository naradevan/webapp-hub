<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clamphook-HOMEPASS Connection Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #0a0a0a;
            color: #e5e5e5;
            line-height: 1.5;
        }

        .header {
            background: #171717;
            border-bottom: 1px solid #262626;
            padding: 1rem 1.5rem;
        }

        .header h1 {
            font-size: 1.125rem;
            font-weight: 500;
            color: #fafafa;
        }

        .header p {
            font-size: 0.875rem;
            color: #a3a3a3;
            margin-top: 0.25rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .progress {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 3rem;
            gap: 0.5rem;
        }

        .progress-step {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 2px solid #404040;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 500;
            color: #737373;
            transition: all 0.3s;
        }

        .progress-step.active {
            background: #fafafa;
            border-color: #fafafa;
            color: #0a0a0a;
        }

        .progress-line {
            width: 4rem;
            height: 2px;
            background: #404040;
            transition: background 0.3s;
        }

        .progress-line.active {
            background: #fafafa;
        }

        .card {
            background: #171717;
            border: 1px solid #262626;
            border-radius: 0.5rem;
            padding: 2rem;
        }

        .alert {
            background: #262626;
            border: 1px solid #404040;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .alert-icon {
            color: #d4d4d4;
            flex-shrink: 0;
        }

        .alert-text {
            font-size: 0.875rem;
            color: #d4d4d4;
        }

        .upload-area {
            text-align: center;
        }

        .upload-icon {
            width: 3rem;
            height: 3rem;
            color: #737373;
            margin: 0 auto 1rem;
        }

        .btn {
            display: inline-block;
            padding: 0.625rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            text-decoration: none;
        }

        .btn-primary {
            background: #fafafa;
            color: #0a0a0a;
        }

        .btn-primary:hover {
            background: #e5e5e5;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            color: #d4d4d4;
            border: 1px solid #404040;
        }

        .btn-secondary:hover {
            background: #262626;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #d4d4d4;
            margin-bottom: 0.5rem;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 0.625rem 1rem;
            border: 1px solid #404040;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            outline: none;
            background: #0a0a0a;
            color: #e5e5e5;
        }

        .form-select:focus, .form-input:focus {
            border-color: #fafafa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-card {
            text-align: center;
            padding: 1rem;
            background: #0a0a0a;
            border-radius: 0.375rem;
            border: 1px solid #262626;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 500;
            color: #fafafa;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #a3a3a3;
            margin-top: 0.25rem;
        }

        .download-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            border: 1px solid #404040;
            border-radius: 0.375rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .download-item:hover {
            background: #262626;
        }

        .download-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .download-text h4 {
            font-size: 0.875rem;
            font-weight: 500;
            color: #e5e5e5;
        }

        .download-text p {
            font-size: 0.75rem;
            color: #a3a3a3;
        }

        .button-group {
            display: flex;
            gap: 0.75rem;
            margin-top: 2rem;
        }

        .hidden {
            display: none;
        }

        .spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid #0a0a0a;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        ::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #525252;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Clamphook-HOMEPASS Connection Generator</h1>
        <p>Process KML files to generate fiber connection lines</p>
    </div>

    <div class="container">
        <!-- Progress Bar -->
        <div class="progress">
            <div class="progress-step active" id="step-1">1</div>
            <div class="progress-line" id="line-1"></div>
            <div class="progress-step" id="step-2">2</div>
            <div class="progress-line" id="line-2"></div>
            <div class="progress-step" id="step-3">3</div>
        </div>

        <!-- Error Alert -->
        <div id="error-alert" class="alert hidden">
            <span class="alert-icon">‚ö†Ô∏è</span>
            <span class="alert-text" id="error-text"></span>
        </div>

        <!-- Step 1: Upload -->
        <div id="step-upload" class="card">
            <div class="upload-area">
                <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <h2 style="font-size: 1.25rem; font-weight: 500; margin-bottom: 0.5rem;">Upload KML File</h2>
                <p style="font-size: 0.875rem; color: #a3a3a3; margin-bottom: 1.5rem;">
                    Select a KML or KMZ file containing Clamphook and HOMEPASS point data
                </p>
                <input type="file" id="file-input" accept=".kml,.kmz" style="display: none;">
                <label for="file-input" class="btn btn-primary">Choose File</label>
                <p id="file-name" style="margin-top: 1rem; font-size: 0.875rem; color: #a3a3a3;"></p>
            </div>
        </div>

        <!-- Step 2: Select Folders & Distance -->
        <div id="step-folders" class="card hidden">
            <h2 style="font-size: 1.25rem; font-weight: 500; margin-bottom: 1.5rem;">Configure Settings</h2>
            
            <div class="form-group">
                <label class="form-label">Clamphook Points Folder</label>
                <select id="clamphook-folder" class="form-select">
                    <option value="">Select folder...</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">HOMEPASS Points Folder</label>
                <select id="homepass-folder" class="form-select">
                    <option value="">Select folder...</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Maximum Distance (meters)</label>
                <input type="number" id="max-distance" class="form-input" value="250" min="1" step="1" 
                       style="width: 12rem;"
                       placeholder="Enter distance in meters">
                <p style="font-size: 0.75rem; color: #737373; margin-top: 0.5rem;">
                    HOMEPASS points will only be assigned to Clamphook within this radius
                </p>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="reset()">Back</button>
                <button id="generate-btn" class="btn btn-primary" onclick="generateOutput()">Generate</button>
            </div>
        </div>

        <!-- Step 3: Results -->
        <div id="step-results" class="hidden">
            <div class="card" style="margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                    <span style="font-size: 1.25rem;">‚úì</span>
                    <h2 style="font-size: 1.25rem; font-weight: 500;">Processing Complete</h2>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-total">0</div>
                        <div class="stat-label">Total HOMEPASS</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-assigned">0</div>
                        <div class="stat-label">Assigned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-unassigned">0</div>
                        <div class="stat-label">Unassigned</div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 1.125rem; font-weight: 500; margin-bottom: 1rem;">Download Results</h3>
                
                <div class="download-item" onclick="downloadKML()">
                    <div class="download-content">
                        <span style="font-size: 1.25rem;">üìÑ</span>
                        <div class="download-text">
                            <h4>KML File with Connections</h4>
                            <p>Contains magenta lines and original styling</p>
                        </div>
                    </div>
                    <span style="font-size: 1.25rem;">‚¨áÔ∏è</span>
                </div>

                <div class="download-item" onclick="downloadCSV()">
                    <div class="download-content">
                        <span style="font-size: 1.25rem;">üìä</span>
                        <div class="download-text">
                            <h4>CSV Assignment Report</h4>
                            <p>HOMEPASS to Clamphook assignments with distances</p>
                        </div>
                    </div>
                    <span style="font-size: 1.25rem;">‚¨áÔ∏è</span>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="btn btn-secondary" onclick="reset()">Process Another File</button>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let parsedKML = null;
        let originalKMLText = '';
        let folderStructure = [];
        let clamphookPoints = [];
        let homepassPoints = [];
        let resultData = null;

        // Format coordinates to specific character count
        // Lat: 9 characters total (e.g., -7.946618)
        // Lon: 10 characters total (e.g., 112.552690)
        function formatLatitude(lat) {
            // For latitude: X.XXXXXX format (9 chars including minus sign and dot)
            // Example: -7.946618 (9 chars)
            const absLat = Math.abs(lat);
            const sign = lat < 0 ? '-' : '';
            
            // Calculate how many decimal places we need
            // Total 9 chars: sign(1) + digit(1) + dot(1) + decimals(6) = 9
            const formatted = absLat.toFixed(6);
            return sign + formatted;
        }

        function formatLongitude(lon) {
            // For longitude: XXX.XXXXXX format (10 chars)
            // Example: 112.552690 (10 chars)
            const absLon = Math.abs(lon);
            const sign = lon < 0 ? '-' : '';
            
            // Determine decimal places based on integer part
            const intPart = Math.floor(absLon).toString();
            const totalChars = sign.length + intPart.length + 1; // sign + digits + dot
            const decimalPlaces = 10 - totalChars;
            
            const formatted = absLon.toFixed(Math.max(0, decimalPlaces));
            return sign + formatted;
        }

        function showError(message) {
            document.getElementById('error-text').textContent = message;
            document.getElementById('error-alert').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('error-alert').classList.add('hidden');
        }

        function updateProgress() {
            for (let i = 1; i <= 3; i++) {
                const step = document.getElementById(`step-${i}`);
                const line = document.getElementById(`line-${i}`);
                
                if (i <= currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
                
                if (line && i < currentStep) {
                    line.classList.add('active');
                } else if (line) {
                    line.classList.remove('active');
                }
            }
        }

        function goToStep(step) {
            document.getElementById('step-upload').classList.add('hidden');
            document.getElementById('step-folders').classList.add('hidden');
            document.getElementById('step-results').classList.add('hidden');
            
            currentStep = step;
            updateProgress();
            
            if (step === 1) document.getElementById('step-upload').classList.remove('hidden');
            if (step === 2) document.getElementById('step-folders').classList.remove('hidden');
            if (step === 3) document.getElementById('step-results').classList.remove('hidden');
        }

        function haversineDistance(coord1, coord2) {
            const toRad = (deg) => (deg * Math.PI) / 180;
            const R = 6371000;
            
            const dLat = toRad(coord2.lat - coord1.lat);
            const dLon = toRad(coord2.lon - coord1.lon);
            
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRad(coord1.lat)) * Math.cos(toRad(coord2.lat)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        async function parseKML(file) {
            try {
                let kmlText = '';
                
                // Check if it's a KMZ file
                if (file.name.toLowerCase().endsWith('.kmz')) {
                    // We need to extract KML from KMZ (which is a ZIP file)
                    const arrayBuffer = await file.arrayBuffer();
                    const uint8Array = new Uint8Array(arrayBuffer);
                    
                    // Simple KMZ extraction - look for doc.kml or *.kml
                    // KMZ is a ZIP file, so we need to parse it
                    // For now, show error and ask user to extract manually
                    showError('KMZ support requires manual extraction. Please unzip your KMZ file and upload the .kml file inside.');
                    return null;
                } else {
                    kmlText = await file.text();
                }
                
                const parser = new DOMParser();
                const xml = parser.parseFromString(kmlText, 'text/xml');
                
                if (xml.getElementsByTagName('parsererror').length > 0) {
                    throw new Error('Invalid KML file format');
                }
                
                return { xml, text: kmlText };
            } catch (err) {
                showError(`Failed to parse file: ${err.message}`);
                return null;
            }
        }

        function extractFolders(xml) {
            const folders = [];
            const folderElements = xml.getElementsByTagName('Folder');
            
            function processFolder(folder, path = '') {
                const nameEl = folder.getElementsByTagName('name')[0];
                const name = nameEl ? nameEl.textContent : 'Unnamed';
                const fullPath = path ? `${path}/${name}` : name;
                
                let count = 0;
                for (let child of folder.children) {
                    if (child.tagName === 'Placemark') count++;
                }
                
                if (count > 0) {
                    folders.push({ name, path: fullPath, count });
                }
                
                for (let child of folder.children) {
                    if (child.tagName === 'Folder') {
                        processFolder(child, fullPath);
                    }
                }
            }
            
            for (let folder of folderElements) {
                if (folder.parentNode.tagName !== 'Folder') {
                    processFolder(folder);
                }
            }
            
            return folders;
        }

        function extractPointsFromFolder(xml, folderPath) {
            const points = [];
            const folders = xml.getElementsByTagName('Folder');
            
            function getFolderPath(folderEl) {
                let path = [];
                let current = folderEl;
                
                while (current && current.tagName === 'Folder') {
                    const nameEl = current.getElementsByTagName('name')[0];
                    if (nameEl) {
                        path.unshift(nameEl.textContent);
                    }
                    current = current.parentNode;
                }
                
                return path.join('/');
            }
            
            for (let folder of folders) {
                const currentPath = getFolderPath(folder);
                
                if (currentPath === folderPath) {
                    for (let child of folder.children) {
                        if (child.tagName === 'Placemark') {
                            const nameEl = child.getElementsByTagName('name')[0];
                            const coordEl = child.getElementsByTagName('coordinates')[0];
                            
                            if (coordEl) {
                                const parts = coordEl.textContent.trim().split(',');
                                if (parts.length >= 2) {
                                    points.push({
                                        id: nameEl ? nameEl.textContent : `Point_${points.length}`,
                                        lon: parseFloat(parts[0]),
                                        lat: parseFloat(parts[1])
                                    });
                                }
                            }
                        }
                    }
                    break;
                }
            }
            
            return points;
        }

        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            hideError();
            document.getElementById('file-name').textContent = `Selected: ${file.name}`;
            
            const result = await parseKML(file);
            if (!result) return;
            
            parsedKML = result.xml;
            originalKMLText = result.text;
            folderStructure = extractFolders(parsedKML);
            
            if (folderStructure.length === 0) {
                showError('No folders with points found in KML file');
                return;
            }
            
            const chSelect = document.getElementById('clamphook-folder');
            const hpSelect = document.getElementById('homepass-folder');
            
            chSelect.innerHTML = '<option value="">Select folder...</option>';
            hpSelect.innerHTML = '<option value="">Select folder...</option>';
            
            folderStructure.forEach(folder => {
                chSelect.innerHTML += `<option value="${folder.path}">${folder.path} (${folder.count} points)</option>`;
                hpSelect.innerHTML += `<option value="${folder.path}">${folder.path} (${folder.count} points)</option>`;
            });
            
            goToStep(2);
        });

        function generateOutput() {
            const chFolder = document.getElementById('clamphook-folder').value;
            const hpFolder = document.getElementById('homepass-folder').value;
            const maxDistance = parseInt(document.getElementById('max-distance').value) || 250;
            
            if (!chFolder || !hpFolder) {
                showError('Please select both Clamphook and HOMEPASS folders');
                return;
            }
            
            if (chFolder === hpFolder) {
                showError('Clamphook and HOMEPASS folders must be different');
                return;
            }
            
            if (maxDistance < 1) {
                showError('Maximum distance must be at least 1 meter');
                return;
            }
            
            hideError();
            const btn = document.getElementById('generate-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Processing...';
            
            setTimeout(() => {
                try {
                    clamphookPoints = extractPointsFromFolder(parsedKML, chFolder);
                    homepassPoints = extractPointsFromFolder(parsedKML, hpFolder);
                    
                    if (clamphookPoints.length === 0 || homepassPoints.length === 0) {
                        showError('Selected folders must contain points');
                        btn.disabled = false;
                        btn.innerHTML = 'Generate';
                        return;
                    }
                    
                    const assignments = [];
                    
                    homepassPoints.forEach(hp => {
                        const candidates = [];
                        
                        clamphookPoints.forEach(ch => {
                            const dist = haversineDistance(
                                { lat: hp.lat, lon: hp.lon },
                                { lat: ch.lat, lon: ch.lon }
                            );
                            
                            if (dist <= maxDistance) {
                                candidates.push({ ch, dist });
                            }
                        });
                        
                        candidates.sort((a, b) => a.dist - b.dist);
                        
                        if (candidates.length > 0) {
                            const assigned = candidates[0];
                            assignments.push({
                                hpId: hp.id,
                                hpLat: hp.lat,
                                hpLon: hp.lon,
                                chId: assigned.ch.id,
                                chLat: assigned.ch.lat,
                                chLon: assigned.ch.lon,
                                dist: assigned.dist.toFixed(2)
                            });
                        } else {
                            assignments.push({
                                hpId: hp.id,
                                hpLat: hp.lat,
                                hpLon: hp.lon,
                                chId: 'UNASSIGNED',
                                chLat: null,
                                chLon: null,
                                dist: 'N/A'
                            });
                        }
                    });
                    
                    let kml = originalKMLText;
                    let style = `
  <Style id="magentaLine">
    <LineStyle>
      <color>ffff00ff</color>
      <width>1</width>
    </LineStyle>
  </Style>
  
  <Folder>
    <n>Clamphook-HOMEPASS Connections</n>`;
                    
                    assignments.forEach(a => {
                        if (a.chId !== 'UNASSIGNED') {
                            style += `
    <Placemark>
      <n>${a.hpId} to ${a.chId}</n>
      <styleUrl>#magentaLine</styleUrl>
      <LineString>
        <coordinates>
          ${a.hpLon},${a.hpLat},0
          ${a.chLon},${a.chLat},0
        </coordinates>
      </LineString>
    </Placemark>`;
                        }
                    });
                    
                    style += '\n  </Folder>';
                    kml = kml.replace('</Document>', style + '\n</Document>');
                    
                    // Generate CSV with formatted coordinates: Lat 9 chars, Lon 10 chars
                    let csv = 'HOMEPASS_ID,HOMEPASS_LAT,HOMEPASS_LON,CLAMPHOOK_ID,CLAMPHOOK_LAT,CLAMPHOOK_LON,DISTANCE_M\n';
                    assignments.forEach(a => {
                        const hpLat = formatLatitude(a.hpLat);
                        const hpLon = formatLongitude(a.hpLon);
                        const chLat = a.chLat ? formatLatitude(a.chLat) : '';
                        const chLon = a.chLon ? formatLongitude(a.chLon) : '';
                        csv += `${a.hpId},${hpLat},${hpLon},${a.chId},${chLat},${chLon},${a.dist}\n`;
                    });
                    
                    resultData = {
                        kml,
                        csv,
                        stats: {
                            total: homepassPoints.length,
                            assigned: assignments.filter(a => a.chId !== 'UNASSIGNED').length,
                            unassigned: assignments.filter(a => a.chId === 'UNASSIGNED').length
                        }
                    };
                    
                    document.getElementById('stat-total').textContent = resultData.stats.total;
                    document.getElementById('stat-assigned').textContent = resultData.stats.assigned;
                    document.getElementById('stat-unassigned').textContent = resultData.stats.unassigned;
                    
                    goToStep(3);
                } catch (err) {
                    showError(`Processing failed: ${err.message}`);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = 'Generate';
                }
            }, 100);
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadKML() {
            downloadFile(resultData.kml, 'connections.kml', 'application/vnd.google-earth.kml+xml');
        }

        function downloadCSV() {
            downloadFile(resultData.csv, 'assignments.csv', 'text/csv');
        }

        function reset() {
            currentStep = 1;
            parsedKML = null;
            originalKMLText = '';
            folderStructure = [];
            clamphookPoints = [];
            homepassPoints = [];
            resultData = null;
            document.getElementById('file-input').value = '';
            document.getElementById('file-name').textContent = '';
            hideError();
            goToStep(1);
        }

        updateProgress();
    </script>
</body>
</html>